<%- include('partials/nav') %>
<%- include('partials/video-modal')%>
<%- include('partials/image-modal')%>
<%- include('partials/blurb-modal')%>
<div class="container">
	<div class="row mt-5 md-5 font-weight-light">
		<div class="col col-sm-0 col-md-3 col-lg-2"></div>
		<div class="col col-sm-12 col-md-6 col-lg-8">
			<h5 class="text-center">Hey <%= user.username %>, what's on your mind?</h5>
			<h6 class="mb-3 text-center font-weight-normal">Why not publish something great.</h6>
			<div class="pl-5 pr-5">
				<div class="post-options row text-center">
					<div class="col post-option" data-toggle="modal" data-target="#blurb-modal"><i
							class="fas fa-comment-dots fa-2x"></i><br><small>blurb</small></div>
					<div class="col post-option" data-toggle="modal" data-target="#image-modal"><i
							class="fas fa-image fa-2x"></i><br><small>image</small></div>
					<div class="col post-option" data-toggle="modal" data-target="#video-modal"><i
							class="fas fa-video fa-2x"></i><br><small>video</small></div>
				</div>
			</div>
			<hr>
		</div>
		<div class="col col-sm-0 col-md-3 col-lg-2"></div>
	</div>
	<div class="row mt-5 md-5 font-weight-light">
		<div class="col-sm-12 col-md-6 col-lg-4 pt-3 explore-section" >
			<h6>Find friends</h6>
			<input class="form-control mr-sm-2" type="search" id="search-bar" placeholder="Search" aria-label="Search">
			<div class="options">

			</div>
		</div>
		<div class="col-sm-12 col-md-6 col-lg-8 pr-5 pl-5 pt-3 timeline-section">
			<div>
				<h6 class="text-center">
					Timeline
					<button class="btn btn-warning float-right" id="refresh-button"><i class="fas fa-sync"></i></button>
				</h6>
			</div>
			<div class="feed mt-5 mb-5">
				<% posts.forEach(function(post) { %>
					<div class="card mb-3">
						<% if (post.type == 'image') { %>
							<img src="<%= post.media %>" class="card-img-top" alt="img">
						<% } %>
						<% if (post.type == 'video') { %>
							<video controls>
								<source src="<%= post.media %>">
								Your browser does not support the video tag.
							</video>
						<% } %>
						<div class="card-body row">
							<div class="col col-sm-12 col-md-10">
								<blockquote class="blockquote card-text">
									<p class="mb-0"><%= post.blurb %></p>
									<footer class="blockquote-footer"><%= post.user.username %></footer>
								</blockquote>
							</div>
							<div class="col col-sm-12 col-md-2">
								<h6 class="text-right"><img src="<%= post.user.picture %>" alt="Avatar" class="avatar mr-3"></h6>
								<br/>
								<button class="btn btn-danger delete-post-button" value="<%=post._id%>">delete</button>
							</div>
							
							<p class="card-text"></p>
						</div>
					</div>
				<% }); %>
			</div>
			<hr>
			<div class="feed-end text-center font-weight-lighter mt-3">
				<span>End of feed.</span>
			</div>
		</div>
	</div>
</div>

<script>
	$(document).ready(function() {
		let page = 2;

		$('#refresh-button').on('click', function() {
			$.ajax({
				type: "DELETE",
				url: "/api/feed"
			})
			.done(function(data) {
				window.location.reload();
			})
			.fail(function(err) {
				console.log(err);
			})
		})

		$('.delete-post-button').on('click', function() {
			$.ajax({
				type: "DELETE",
				url: "/api/post",
				data: {
					post: this.value
				}
			})
			.done(function(data) {
				window.location.reload();
			})
			.fail(function(err) {
				console.log(err);
			})
		})

		$("#search-bar").on('input',function() {
			$('.options').html("")
			const searchText = $("#search-bar").val();
			if (searchText == '') return;
			$.ajax({
				type: "get",
				url: "/api/users?text="+searchText
			})
			.done(function(data) {
				console.log(data);
				data.users.forEach(function(match){
					$('.options').prepend($("<a href='/u/"+match._id+"' class='match-link'><div class='card'><div class='card-body'><p class='card-text text-left'><img src='" + match.picture +"' alt='Avatar' class='avatar mr-3'>"+match.username+"</p></div></div></a>"))
				});
			})
			.fail(function(err) {
				alert('server error!'+err)
			});
		});

		let working = false;
		$("body").scroll(function () {
			if ($("body").scrollTop() >= $(document).height() - $("body").height() ) {
				if (!working){
					working = true;
					$.ajax({
						type: "get",
						url: "/api/post/feed?page=" + page
					})
					.done(function (data) {
						for (let i = 0; i < data.posts.length; i++){
							let post = data.posts[i];
							let html = "";
							if (post.type = 'blurb') {
								html = "<div class='card mb-3'><div class='card-body row'><div class='col col-sm-12 col-md-10'><blockquote class='blockquote card-text'><p class='mb-0'>" + post.blurb + "%></p><footer class='blockquote-footer'>" + post.user.username + "</footer></blockquote></div><div class='col col-sm-12 col-md-2'><h6 class='text-right'><img src='" + post.user.picture + "' alt='Avatar' class='avatar mr-3'></h6></div><p class='card-text'></p></div></div>"
							}
							else if (post.type = 'image') {
								html = "<div class='card mb-3'><div class='card-body row'><div class='col col-sm-12 col-md-10'><img src='" + post.media + "' class='card-img-top' alt='img'><blockquote class='blockquote card-text'><p class='mb-0'>" + post.blurb + "%></p><footer class='blockquote-footer'>" + post.user.username + "</footer></blockquote></div><div class='col col-sm-12 col-md-2'><h6 class='text-right'><img src='" + post.user.picture + "' alt='Avatar' class='avatar mr-3'></h6></div><p class='card-text'></p></div></div>"
							}
							else if (post.type = 'video') {
								html = "<div class='card mb-3'><div class='card-body row'><div class='col col-sm-12 col-md-10'><video controls><source src='" + post.media + "'>Your browser does not support the video tag.</video><blockquote class='blockquote card-text'><p class='mb-0'>" + post.blurb + "%></p><footer class='blockquote-footer'>" + post.user.username + "</footer></blockquote></div><div class='col col-sm-12 col-md-2'><h6 class='text-right'><img src='" + post.user.picture + "' alt='Avatar' class='avatar mr-3'></h6></div><p class='card-text'></p></div></div>"
							}
							$(".feed").append(html);
						}
						working = false;
						page += 1;
					})
					.fail(function (err) {
						alert("server error! " + err);
					});
				}
			}
		});
	});
</script>

<style>
	#search-bar {
		width: 100%
	}
	.explore-section {
		border-right: 1px solid rgba(0,0,0,0.1);
	}
	.match-link {
		text-decoration: none!important;
		color: black;
	}
	video {
 		width: 100%    !important;
  		height: auto   !important;
		max-height: 50vh !important;
	}
	.avatar {
		vertical-align: middle;
		width: 50px;
		height: 50px;
		border-radius: 50%;
	}
	.post-options {
		border: 1px solid grey;
		border-radius: 5px;
	}
	.post-option {
		border-right: 1px solid grey;
		cursor: pointer;
		padding: 0.5em 0em 0.5em 0em;
	}
	.post-option:last-child {
		border-right: none;
		border-radius: 5px;
	}
	.post-option:first-child {
		border-top-left-radius: 5px;
		border-bottom-left-radius: 5px;
	}
	.post-option:hover {
		background-color: rgb(255, 249, 241);
	}
</style>